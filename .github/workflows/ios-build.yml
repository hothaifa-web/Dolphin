name: iOS CI - Build Archive (macOS)

on:
  workflow_dispatch: {}
  push:
    branches: [ main, master ]

jobs:
  build-ios:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Build web assets
        run: npm run build

      - name: Sync Capacitor iOS
        run: npx cap sync ios

      - name: Archive iOS (xcarchive)
        working-directory: ios
        env:
          # Avoid exporting signed IPA; create xcarchive for later signed export on a Mac with certs
          GITHUB_XCODE_ACTIONS_ALLOW_UNSIGNED: 'true'
        run: |
          set -o pipefail
          # Try common workspace path used by Capacitor (ios/App)
          if [ -d "App" ]; then
            cd App
            xcodebuild -workspace App.xcworkspace -scheme App -configuration Release -archivePath $PWD/build/App.xcarchive -allowProvisioningUpdates | xcpretty || true
          else
            # fallback to ios/ folder root
            xcodebuild -scheme App -configuration Release -archivePath $PWD/build/App.xcarchive -allowProvisioningUpdates | xcpretty || true
          fi

      - name: Upload xcarchive artifact
        uses: actions/upload-artifact@v3
        with:
          name: ios-xcarchive
          path: ios/App/build/App.xcarchive

      - name: Note
        run: |
          echo "This workflow produces an xcarchive (unsigned). To create an installable IPA or App Store build you must provide Apple signing credentials and export options. See README_MOBILE.md for details."
